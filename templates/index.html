<html lang="en">
  <head>
    <title>Project ii gae</title> 
    <meta name="google-signin-scope" content="profile email">
    <meta name="google-signin-client_id" content="{{ sign_in_key }}">
    <script src="https://apis.google.com/js/platform.js" async defer></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    <script src="/static/index.js"></script>
    <link rel="stylesheet" href="/static/index.css">
  </head>
  
  <body>
  <div class="bgimg">
    <div 
        class="g-signin2" 
        data-onsuccess="onSignIn" 
        data-theme="dark"
        data-longtitle="true"
    ></div>

    <h1 id="project-title">text detector</h1>
    
    <p>
    Utilize Google App Engine to find text in your image.<br>
    Sign in with your google account before you upload your image. <br>
    Only images in JPEG or PNG format are allowed. <br>
    File must be at least 100B and no more than 2MB.
    </p>

    <form id="califormication" enctype="multipart/form-data">
        <input value="" id="text-input" type="text" name="email" disabled required/>
        <input type="file" name="file" accept="image/*" disabled required/>  
        <input type = "submit" value="Upload" disabled />  
    </form>  
    <p> {{ message }} </p>
    </div>

  <script>
      function processForm(e) {
    if (e.preventDefault) e.preventDefault();
    var auth2 = gapi.auth2.getAuthInstance();
    if (auth2.isSignedIn.get()) {
        
        var myForm = document.getElementById('califormication');
        var formData = new FormData(myForm);
        formData.append("gid", auth2.currentUser.get().getAuthResponse().id_token);
         
        var xhr = new XMLHttpRequest();
        xhr.onreadystatechange = function () {
            if(xhr.readyState === XMLHttpRequest.DONE && (xhr.status === 200 || xhr.status === 302)) {
                window.location.replace(`${xhr.responseURL}`);
            }
        };
        xhr.open('POST', '/', true);
        xhr.send(formData);
    }
    return true;
}

function onSignIn(googleUser) { 
    var i;
    for (i = 0; i < document.getElementsByTagName('input').length; i++) {
        document.getElementsByTagName('input')[i].disabled = false;
    } 

    var profile = googleUser.getBasicProfile();

    document.getElementById('text-input').value = profile.getEmail();

    $.ajax({
        data: {
            type: 'in',
            loggedIn: googleUser.getAuthResponse().id_token
        },
        type: 'POST',
        url: '/login'
    })

    var a = document.createElement('a');
    a.href = "#";
    a.onclick = function () { signOut(); };
    t = document.createTextNode("Sign Out");
    a.appendChild(t);
    document.getElementsByClassName("bgimg")[0].appendChild(a);

    var form = document.getElementById('califormication');
    if (form.attachEvent) {
        form.attachEvent("submit", processForm);
    } else {
        form.addEventListener("submit", processForm);
}
}

function signOut() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function () {
        var i;
        for (i = 0; i < document.getElementsByTagName('input').length; i++) {
            document.getElementsByTagName('input')[i].disabled = true;
        } 
    });

    var googleUser = auth2.currentUser.get()

    $.ajax({
        data: {
            type: 'out',
            loggedIn: googleUser.getAuthResponse().id_token
        },
        type: 'POST',
        url: '/login'
    })
    window.location.reload(false); 
}
  </script>
  </body>
</html>
